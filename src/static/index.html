ubuntu@sandbox:~ $ source /home/ubuntu/.user_env && cd /home/ubuntu && echo '```html'; cat professional_layla_fix.html; echo '```'
[previous content truncated]...is.scrollHeight, 120) + 'px';
        });
        // Send message on Enter (but allow Shift+Enter for new lines)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        // Send button click
        document.getElementById('send-button').addEventListener('click', sendMessage);
        function askLayla(message) {
            chatInput.value = message;
            sendMessage();
        }
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            // Clear input and disable send button
            chatInput.value = '';
            chatInput.style.height = 'auto';
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            // Add user message to chat
            addMessage(message, 'user');
            // Show loading indicator
            const loadingId = addLoadingMessage();
            try {
                // Send message to Layla API
                const response = await fetch('/api/layla/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory
                    })
                });
                const data = await response.json();
                // Remove loading indicator
                removeLoadingMessage(loadingId);
                if (response.ok) {
                    // Add Layla's response
                    addMessage(data.response, 'layla');
                    
                    // Update conversation history
                    conversationHistory.push(
                        { role: 'user', content: message },
                        { role: 'assistant', content: data.response }
                    );
                    
                    // Keep only last 10 exchanges to manage context length
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }
                } else {
                    addMessage('I apologize, but I encountered an error. Please try again.', 'layla');
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('I apologize, but I\'m having trouble connecting right now. Please try again in a moment.', 'layla');
            }
            // Re-enable send button
            sendButton.disabled = false;
            chatInput.focus();
        }
        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        function addLoadingMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message layla';
            
            loadingDiv.innerHTML = `
                <div class="message-content">
                    <div class="loading">
                        <span>Layla is thinking</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return loadingId;
        }
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        // Focus on input when page loads
        window.addEventListener('load', () => {
            chatInput.focus();
        });
    </script>
</body>
</html>
```
ubuntu@sandbox:~ $


live
